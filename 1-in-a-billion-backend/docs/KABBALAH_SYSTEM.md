# Kabbalah System Specification

## Overview

Kabbalah is treated as a **distinct system** and must NOT be processed through the same pipeline as Western astrology, Vedic astrology, Human Design, or Gene Keys.

| System | Type | Data Source | Calculations |
|--------|------|-------------|--------------|
| Western | Astronomical | Swiss Ephemeris | Planetary positions |
| Vedic | Astronomical | Swiss Ephemeris | Nakshatras, Dashas |
| Human Design | Astronomical + Numerical | Swiss Ephemeris | Gates, Centers |
| Gene Keys | Numerical | I Ching mapping | Hexagrams |
| **Kabbalah** | **Symbolic + Linguistic** | **Hebrew calendar, Names, Life events** | **Gematria, Sacred time** |

Kabbalah is **symbolic, linguistic, and structural**. It relies on:
- Sacred time (Hebrew calendar)
- Hebrew language and letters
- Names (as channels of expression)
- Life events (as activation points)

**NOT** planetary charts or zodiac positions.

---

## Required User Input

### Standard Birth Data (Already Collected)
Reused from existing onboarding:
- Birth date
- Exact birth time
- Birth location (for timezone conversion only)

### Kabbalah-Specific Input (NEW)

#### 1. Full Name (MANDATORY)
```
First Name: _____________
Surname: _____________
```
- If user has a Hebrew name, use that
- If not, secular name will be transliterated to Hebrew letters by the system

#### 2. Life Events (OPTIONAL but encouraged)
Single free-text input field. User writes everything in one message.

**Prompt text:**
> Please share any meaningful moments from your life - both beautiful and difficult. This might include partnerships, separations, losses, turning points, or periods that felt defining. You may also include the names of people who played an important role in your life. Write everything in one message.

**What NOT to do:**
- ❌ No menus
- ❌ No checkboxes  
- ❌ No structured forms
- ❌ No labels like "trauma", "marriage", "death"
- ❌ No mystical or spiritual language

**What TO do:**
- ✅ Open, neutral language
- ✅ Single text input
- ✅ Non-directive framing

---

## UI Flow: Infusion Screen Modifications

### Standalone Kabbalah Purchase
When user buys Kabbalah for themselves or someone else:
1. Show the **Infusion Screen** (circles with text input)
2. Ask for **full name** (first + surname)
3. Ask for **life events** in the neutral prompt above
4. Collect and proceed to processing

### Nuclear Reading (All 5 Systems)
When Kabbalah is part of a nuclear reading:
1. Show the **Infusion Screen** BEFORE text generation begins
2. **Do NOT mention Kabbalah specifically**
3. Use this generic prompt:

> The more you can tell us about meaningful moments in your life - the beautiful and the difficult - the richer your reading will be. This helps some of our systems understand you more deeply. Write anything that comes to mind.

For overlay readings (two people):
> You may also share meaningful moments from your life together, or from each person's individual journey. Include names if helpful.

---

## Preprocessing Pipeline

All deterministic computation happens BEFORE calling the LLM.

### Required Libraries

#### 1. Hebrew Calendar Conversion
**Library:** `hebcal` or equivalent
```bash
npm install @hebcal/core
```

**Purpose:**
- Convert Gregorian birth date → Hebrew date
- Get Hebrew weekday
- Determine sacred time context (holidays, special days)

#### 2. Timezone Conversion
**Library:** Swiss Ephemeris time handling or `luxon`
```bash
npm install luxon
```

**Purpose:**
- Ensure correct historical timezone and daylight saving before Hebrew date conversion

#### 3. Hebrew Transliteration & Gematria
**Library:** `gematria` or custom implementation
```bash
npm install gematria
```

**Purpose:**
- Convert names to Hebrew letters
- Compute letter values (including final letter forms)
- Full name aggregation

### Static Data (No LLM)
- Sefirotic correspondences
- Letter associations
- Tree of Life mappings

These are **static lookup tables**, not generated by LLM.

### What Is NOT Used
- ❌ Planetary positions
- ❌ Zodiac signs
- ❌ Swiss Ephemeris astronomical calculations
- ❌ Any data from Western/Vedic/HD/GK pipelines

---

## Data Payload to LLM

The LLM receives **only structured, precomputed data**. It does NOT calculate anything.

```typescript
interface KabbalahPayload {
  // Precomputed by libraries
  hebrewDate: {
    day: number;
    month: string;        // Hebrew month name
    year: number;         // Hebrew year
    weekday: string;      // Hebrew weekday
    specialDay?: string;  // Holiday or special significance
  };
  
  birthTimeContext: {
    normalized: string;   // e.g., "morning", "evening", "midnight"
    sacredContext?: string;
  };
  
  // From user input, processed by gematria library
  fullName: {
    firstName: {
      secular: string;
      hebrew: string;           // Transliterated
      letters: string[];        // Individual Hebrew letters
      gematria: number;         // Numeric value
    };
    surname: {
      secular: string;
      hebrew: string;
      letters: string[];
      gematria: number;
    };
    totalGematria: number;
  };
  
  // Optional
  previousSurnames?: string[];
  
  // From user free text (passed as-is)
  relatedPeople?: {
    name: string;
    relationship?: string;
  }[];
  
  lifeEvents?: string;  // Raw user text, unprocessed
}
```

---

## LLM Configuration

### Model
**OpenAI** models only. Not DeepSeek.

```typescript
const KABBALAH_LLM_CONFIG = {
  provider: 'openai',
  model: 'gpt-4o',  // or 'gpt-4-turbo'
  temperature: 0.7,
  max_tokens: 4000,
};
```

### System Prompt
```
You are interpreting Kabbalah data. Your role is interpretation and synthesis ONLY.

All calculations have been done. You receive:
- Hebrew date and sacred time context
- Hebrew letters and gematria values (already computed)
- Life events as described by the user

Your interpretation principles:
- Letters are structural forces, not symbols
- Numbers are qualitative states, not predictions
- Birth moment is placement in sacred time, not fate
- Names are channels of expression and rectification
- Life events are activation points, not causes
- Other people are relational mirrors, not compatibility scores

You do NOT:
- Calculate dates or gematria (already done)
- Predict outcomes
- Use astrological forecasting language
- Make moral judgments
- Use sentimental language
- Explain methodology

Output style:
- Continuous prose
- No bullet points
- Direct address to the person
```

---

## Interpretation Logic

### Letters
Treated as **structural forces**, not decorative symbols.

### Numbers (Gematria)
Treated as **qualitative states**, not numerological predictions.

### Birth Moment
**Placement within sacred time**, not deterministic fate.

### Names
**Channels of expression and rectification**. The name reveals the soul's pathway.

### Life Events
**Activation points**. Events do not cause the soul's nature - they reveal and activate what is already present.

### Related People
**Relational mirrors** or shared rectification vectors. NOT compatibility scores.

---

## Output Format

- **Continuous prose** (no bullet points)
- **No moral judgment**
- **No sentimental language**
- **No explanation of methodology**
- Writing style from user preferences applies to tone, NOT structure

---

## Implementation Checklist

### Backend
- [ ] Install `@hebcal/core` for Hebrew calendar
- [ ] Install `gematria` for Hebrew letter computation
- [ ] Install `luxon` for timezone handling
- [ ] Create `KabbalahPreprocessor` service
- [ ] Create `KabbalahPromptBuilder` 
- [ ] Configure OpenAI (not DeepSeek) for Kabbalah
- [ ] Create Kabbalah-specific route/endpoint

### Frontend
- [ ] Modify Infusion Screen to accept name + life events
- [ ] Create Kabbalah-specific input flow
- [ ] Add generic prompt for nuclear readings
- [ ] Store name/life events in job params

### Database
- [ ] Add `kabbalah_data` field to jobs or people table
- [ ] Store Hebrew name, gematria, life events

---

## File Structure

```
1-in-a-billion-backend/
├── src/
│   ├── services/
│   │   ├── kabbalah/
│   │   │   ├── KabbalahPreprocessor.ts    # Hebrew date, gematria
│   │   │   ├── HebrewCalendarService.ts   # @hebcal/core wrapper
│   │   │   ├── GematriaService.ts         # Name → Hebrew → numbers
│   │   │   └── KabbalahPromptBuilder.ts   # Build LLM payload
│   │   └── ...
│   ├── prompts/
│   │   └── kabbalah.ts                    # System prompts
│   └── routes/
│       └── kabbalah.ts                    # API endpoints
```

---

## Summary

| Aspect | Kabbalah | Other Systems |
|--------|----------|---------------|
| Data source | Names, dates, life events | Birth chart |
| Calculations | Hebrew calendar, gematria | Swiss Ephemeris |
| LLM provider | **OpenAI** | DeepSeek |
| User input | Name + free text | Birth data only |
| Interpretation | Symbolic, linguistic | Astronomical |
| Predictions | Never | Never |

Kabbalah is a **symbolic system**, not an astrological one. It requires:
1. Additional user input (name + life events)
2. Different preprocessing (Hebrew calendar + gematria)
3. Separate LLM configuration (OpenAI)
4. Unique interpretation logic (letters as forces, not symbols)
