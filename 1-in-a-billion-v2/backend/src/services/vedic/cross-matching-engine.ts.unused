/**
 * VEDIC CROSS-MATCHING ENGINE
 * 
 * Implements scalable, deterministic partner matching using precomputed
 * Vedic astrology data as defined in JYOTISH_CROSS_MATCHING_ENGINE_SPEC.md
 * 
 * This engine computes scores, applies filters, and produces ranked results.
 * It does NOT generate interpretations or perform LLM reasoning.
 * 
 * NOTE: This file is currently unused. Commenting out broken import.
 */

import { calculateAshtakoota, getCompatibilityLevel } from './ashtakoota-engine';
// import { Ashtakoota, NakshatraAttributes } from './types';

// Stub types from ashtakoota-engine
type Nakshatra = string;
interface NakshatraAttributes { nakshatra: Nakshatra; pada: number; yoni: string; gana: string; nadi: string; varna: string; }
interface Ashtakoota { varna: any; vashya: any; tara: any; yoni: any; graha_maitri: any; gana: any; bhakoot: any; nadi: any; total_score: number; }

// ============================================================================
// TYPES
// ============================================================================

export interface PersonRecord {
    user_id: string;
    person_id: string;
    moon_nakshatra: NakshatraAttributes['nakshatra'];
    nakshatra_attributes: NakshatraAttributes;
    dasha_snapshot?: string[];
}

export interface MatchResult {
    candidate_person_id: string;
    total_guna_score: number;
    ashtakoota_breakdown: Ashtakoota;
    dosha_flags: string[];
    rank_position: number;
    weighted_score: number;
}

export interface MatchFilters {
    minimum_guna_threshold?: number;
    exclude_nadi_dosha?: boolean;
    exclude_gana_incompatibility?: boolean;
    exclude_yoni_incompatibility?: boolean;
    require_dasha_overlap?: boolean;
}

export interface WeightConfig {
    total_guna_weight: number;      // Default: 0.60
    nadi_weight: number;             // Default: 0.20
    gana_weight: number;             // Default: 0.10
    yoni_weight: number;             // Default: 0.10
}

// ============================================================================
// DEFAULT CONFIGURATION
// ============================================================================

const DEFAULT_WEIGHTS: WeightConfig = {
    total_guna_weight: 0.60,
    nadi_weight: 0.20,
    gana_weight: 0.10,
    yoni_weight: 0.10,
};

// ============================================================================
// VALIDATION
// ============================================================================

function validatePersonRecord(person: PersonRecord): boolean {
    return !!(
        person.user_id &&
        person.person_id &&
        person.moon_nakshatra &&
        person.nakshatra_attributes &&
        person.nakshatra_attributes.nakshatra &&
        person.nakshatra_attributes.pada &&
        person.nakshatra_attributes.yoni &&
        person.nakshatra_attributes.gana &&
        person.nakshatra_attributes.nadi &&
        person.nakshatra_attributes.varna
    );
}

// ============================================================================
// BLOCKING RULES
// ============================================================================

function isBlocked(
    ashtakoota: Ashtakoota,
    filters: MatchFilters
): boolean {
    // Nadi Dosha blocking
    if (filters.exclude_nadi_dosha &&
        ashtakoota.nadi.dosha_present &&
        !ashtakoota.nadi.dosha_cancelled) {
        return true;
    }

    // Bhakoot Dosha blocking
    if (ashtakoota.bhakoot.dosha_present && ashtakoota.bhakoot.score === 0) {
        return true;
    }

    // Gana incompatibility blocking
    if (filters.exclude_gana_incompatibility && ashtakoota.gana.score === 0) {
        return true;
    }

    // Yoni incompatibility blocking
    if (filters.exclude_yoni_incompatibility &&
        ashtakoota.yoni.relationship_type === 'enemy') {
        return true;
    }

    // Minimum Guna threshold
    if (filters.minimum_guna_threshold &&
        ashtakoota.total_score < filters.minimum_guna_threshold) {
        return true;
    }

    return false;
}

// ============================================================================
// DOSHA FLAG EXTRACTION
// ============================================================================

function extractDoshaFlags(ashtakoota: Ashtakoota): string[] {
    const flags: string[] = [];

    if (ashtakoota.nadi.dosha_present) {
        if (ashtakoota.nadi.dosha_cancelled) {
            flags.push('nadi_dosha_cancelled');
        } else {
            flags.push('nadi_dosha_active');
        }
    }

    if (ashtakoota.bhakoot.dosha_present) {
        flags.push('bhakoot_dosha');
    }

    if (ashtakoota.gana.score === 0) {
        flags.push('gana_incompatibility');
    }

    if (ashtakoota.yoni.relationship_type === 'enemy') {
        flags.push('yoni_enemy');
    }

    return flags;
}

// ============================================================================
// WEIGHTED SCORE CALCULATION
// ============================================================================

function calculateWeightedScore(
    ashtakoota: Ashtakoota,
    weights: WeightConfig = DEFAULT_WEIGHTS
): number {
    const gunaScore = (ashtakoota.total_score / 36) * weights.total_guna_weight;
    const nadiScore = (ashtakoota.nadi.score / 8) * weights.nadi_weight;
    const ganaScore = (ashtakoota.gana.score / 6) * weights.gana_weight;
    const yoniScore = (ashtakoota.yoni.score / 4) * weights.yoni_weight;

    return gunaScore + nadiScore + ganaScore + yoniScore;
}

// ============================================================================
// MODE A: ONE-TO-ONE MATCHING
// ============================================================================

export function matchOneToOne(
    personA: PersonRecord,
    personB: PersonRecord,
    maleFirst: boolean = true
): {
    ashtakoota: Ashtakoota;
    dosha_flags: string[];
    compatibility_level: string;
} {
    if (!validatePersonRecord(personA) || !validatePersonRecord(personB)) {
        throw new Error('Invalid person records: missing required fields');
    }

    const ashtakoota = calculateAshtakoota(
        personA.nakshatra_attributes,
        personB.nakshatra_attributes,
        maleFirst
    );

    const dosha_flags = extractDoshaFlags(ashtakoota);
    const compatibility_level = getCompatibilityLevel(ashtakoota.total_score);

    return {
        ashtakoota,
        dosha_flags,
        compatibility_level,
    };
}

// ============================================================================
// MODE B: ONE-TO-MANY MATCHING
// ============================================================================

export function matchOneToMany(
    person: PersonRecord,
    candidates: PersonRecord[],
    filters: MatchFilters = {},
    weights: WeightConfig = DEFAULT_WEIGHTS,
    maleFirst: boolean = true
): MatchResult[] {
    if (!validatePersonRecord(person)) {
        throw new Error('Invalid person record: missing required fields');
    }

    const results: MatchResult[] = [];

    for (const candidate of candidates) {
        // Skip invalid records
        if (!validatePersonRecord(candidate)) {
            continue;
        }

        // Skip self-matching
        if (candidate.person_id === person.person_id) {
            continue;
        }

        // Calculate Ashtakoota
        const ashtakoota = calculateAshtakoota(
            person.nakshatra_attributes,
            candidate.nakshatra_attributes,
            maleFirst
        );

        // Apply blocking rules
        if (isBlocked(ashtakoota, filters)) {
            continue;
        }

        // Calculate weighted score
        const weighted_score = calculateWeightedScore(ashtakoota, weights);

        // Extract dosha flags
        const dosha_flags = extractDoshaFlags(ashtakoota);

        results.push({
            candidate_person_id: candidate.person_id,
            total_guna_score: ashtakoota.total_score,
            ashtakoota_breakdown: ashtakoota,
            dosha_flags,
            rank_position: 0, // Will be set after sorting
            weighted_score,
        });
    }

    // Sort by weighted score (descending), then by total Guna score
    results.sort((a, b) => {
        if (b.weighted_score !== a.weighted_score) {
            return b.weighted_score - a.weighted_score;
        }
        if (b.total_guna_score !== a.total_guna_score) {
            return b.total_guna_score - a.total_guna_score;
        }
        // Tie-breaker: Nadi presence (no dosha is better)
        const aNadiDosha = a.dosha_flags.includes('nadi_dosha_active') ? 1 : 0;
        const bNadiDosha = b.dosha_flags.includes('nadi_dosha_active') ? 1 : 0;
        return aNadiDosha - bNadiDosha;
    });

    // Assign rank positions
    results.forEach((result, index) => {
        result.rank_position = index + 1;
    });

    return results;
}

// ============================================================================
// MODE C: MANY-TO-MANY MATCHING
// ============================================================================

export function matchManyToMany(
    setA: PersonRecord[],
    setB: PersonRecord[],
    topN: number = 10,
    filters: MatchFilters = {},
    weights: WeightConfig = DEFAULT_WEIGHTS
): Map<string, MatchResult[]> {
    const compatibilityMatrix = new Map<string, MatchResult[]>();

    for (const personA of setA) {
        if (!validatePersonRecord(personA)) {
            continue;
        }

        const matches = matchOneToMany(personA, setB, filters, weights, true);
        const topMatches = matches.slice(0, topN);

        compatibilityMatrix.set(personA.person_id, topMatches);
    }

    return compatibilityMatrix;
}

// ============================================================================
// UTILITY: GET MATCH SUMMARY
// ============================================================================

export function getMatchSummary(result: MatchResult): {
    score: string;
    level: string;
    doshas: string[];
    recommendation: string;
} {
    const level = getCompatibilityLevel(result.total_guna_score);

    let recommendation: string;
    if (result.total_guna_score < 18) {
        recommendation = 'not_recommended';
    } else if (result.dosha_flags.includes('nadi_dosha_active')) {
        recommendation = 'proceed_with_caution';
    } else if (result.total_guna_score >= 25) {
        recommendation = 'highly_favorable';
    } else {
        recommendation = 'proceed_with_awareness';
    }

    return {
        score: `${result.total_guna_score}/36`,
        level,
        doshas: result.dosha_flags,
        recommendation,
    };
}
